/*
 * Copyright 2012 Google Inc.
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// Resolve frequency signal (1.0 in Q24 format = 1 octave) to phase delta.

// The LUT is just a global, and we'll need the init function to be called before
// use.

#include <stdint.h>
#include <math.h>
 #include <stdio.h>

#include "freqlut.h"

#define LG_N_SAMPLES 10
#define N_SAMPLES (1 << LG_N_SAMPLES)
#define SAMPLE_SHIFT (24 - LG_N_SAMPLES)

#define MAX_LOGFREQ_INT 20

const int32_t lut[] = {
366503876,366752047,367000386,367248893,367497569,367746413,367995425,368244606,368493956,368743474,
368993162,369243018,369493044,369743239,369993604,370244138,370494841,370745715,370996758,371247971,
371499355,371750909,372002632,372254527,372506592,372758827,373011234,373263811,373516560,373769479,
374022570,374275832,374529266,374782871,375036648,375290597,375544718,375799010,376053476,376308113,
376562923,376817905,377073060,377328388,377583888,377839562,378095409,378351429,378607622,378863989,
379120529,379377244,379634131,379891193,380148429,380405840,380663424,380921183,381179116,381437224,
381695507,381953965,382212598,382471406,382730389,382989547,383248881,383508391,383768076,384027937,
384287974,384548188,384808577,385069143,385329885,385590803,385851899,386113171,386374620,386636246,
386898049,387160030,387422188,387684523,387947036,388209727,388472596,388735643,388998868,389262271,
389525852,389789612,390053551,390317668,390581964,390846439,391111093,391375926,391640939,391906131,
392171503,392437054,392702785,392968696,393234788,393501059,393767511,394034143,394300955,394567949,
394835123,395102478,395370014,395637731,395905629,396173709,396441970,396710413,396979038,397247845,
397516834,397786005,398055358,398324893,398594611,398864512,399134595,399404861,399675311,399945943,
400216759,400487758,400758940,401030307,401301857,401573590,401845508,402117610,402389896,402662367,
402935022,403207862,403480886,403754095,404027490,404301069,404574834,404848784,405122919,405397240,
405671747,405946440,406221319,406496384,406771635,407047073,407322697,407598507,407874505,408150689,
408427060,408703619,408980365,409257298,409534419,409811727,410089223,410366907,410644779,410922839,
411201088,411479525,411758150,412036964,412315967,412595159,412874540,413154110,413433869,413713818,
413993956,414274284,414554802,414835510,415116407,415397496,415678774,415960243,416241902,416523752,
416805793,417088025,417370448,417653063,417935869,418218866,418502055,418785435,419069008,419352772,
419636729,419920878,420205219,420489753,420774479,421059399,421344511,421629816,421915315,422201007,
422486892,422772971,423059243,423345710,423632370,423919224,424206273,424493516,424780954,425068586,
425356413,425644435,425932652,426221064,426509671,426798474,427087472,427376666,427666056,427955642,
428245424,428535402,428825577,429115948,429406515,429697279,429988241,430279399,430570754,430862307,
431154057,431446005,431738150,432030493,432323034,432615774,432908711,433201847,433495181,433788714,
434082446,434376376,434670506,434964834,435259362,435554090,435849017,436144144,436439470,436734997,
437030723,437326650,437622778,437919106,438215634,438512363,438809293,439106425,439403757,439701291,
439999026,440296963,440595102,440893442,441191984,441490729,441789676,442088825,442388177,442687732,
442987489,443287450,443587613,443887980,444188550,444489324,444790301,445091483,445392868,445694457,
445996250,446298248,446600450,446902857,447205469,447508285,447811307,448114534,448417966,448721603,
449025446,449329495,449633750,449938211,450242878,450547751,450852831,451158117,451463610,451769310,
452075217,452381331,452687652,452994181,453300917,453607861,453915013,454222373,454529941,454837717,
455145701,455453895,455762296,456070907,456379727,456688755,456997993,457307441,457617098,457926964,
458237041,458547327,458857823,459168530,459479447,459790575,460101913,460413462,460725222,461037194,
461349376,461661770,461974375,462287192,462600221,462913462,463226915,463540580,463854458,464168548,
464482850,464797366,465112095,465427036,465742191,466057559,466373141,466688937,467004946,467321170,
467637607,467954259,468271125,468588206,468905501,469223012,469540737,469858677,470176833,470495204,
470813791,471132594,471451612,471770846,472090297,472409964,472729847,473049947,473370263,473690797,
474011548,474332515,474653700,474975103,475296723,475618561,475940617,476262891,476585383,476908094,
477231023,477554171,477877537,478201123,478524928,478848952,479173195,479497658,479822340,480147243,
480472365,480797708,481123271,481449054,481775058,482101283,482427728,482754395,483081283,483408392,
483735722,484063275,484391049,484719045,485047263,485375703,485704366,486033252,486362360,486691690,
487021244,487351021,487681022,488011246,488341693,488672364,489003259,489334378,489665722,489997289,
490329081,490661098,490993340,491325807,491658498,491991416,492324558,492657926,492991520,493325340,
493659385,493993657,494328155,494662880,494997832,495333010,495668415,496004047,496339907,496675994,
497012308,497348851,497685621,498022619,498359846,498697300,499034984,499372895,499711036,500049406,
500388005,500726833,501065890,501405177,501744694,502084441,502424418,502764625,503105062,503445730,
503786628,504127758,504469118,504810710,505152533,505494587,505836873,506179390,506522140,506865122,
507208336,507551782,507895461,508239372,508583517,508927894,509272505,509617349,509962427,510307738,
510653283,510999062,511345075,511691323,512037805,512384521,512731472,513078659,513426080,513773736,
514121628,514469756,514818119,515166718,515515554,515864625,516213933,516563477,516913258,517263276,
517613531,517964023,518314752,518665719,519016923,519368366,519720046,520071964,520424121,520776516,
521129150,521482022,521835134,522188484,522542074,522895904,523249972,523604281,523958830,524313618,
524668647,525023916,525379426,525735177,526091168,526447401,526803874,527160589,527517546,527874744,
528232184,528589867,528947791,529305958,529664367,530023019,530381914,530741052,531100433,531460057,
531819925,532180037,532540392,532900992,533261835,533622923,533984256,534345833,534707655,535069722,
535432034,535794591,536157394,536520443,536883737,537247278,537611065,537975098,538339377,538703903,
539068676,539433696,539798963,540164478,540530239,540896249,541262507,541629012,541995766,542362768,
542730018,543097517,543465265,543833262,544201508,544570004,544938749,545307744,545676988,546046483,
546416228,546786223,547156469,547526965,547897713,548268711,548639961,549011461,549383214,549755218,
550127474,550499983,550872743,551245756,551619021,551992539,552366310,552740335,553114612,553489143,
553863927,554238966,554614258,554989804,555365605,555741660,556117970,556494534,556871354,557248429,
557625759,558003344,558381185,558759282,559137635,559516245,559895110,560274232,560653611,561033247,
561413140,561793290,562173697,562554362,562935285,563316466,563697905,564079602,564461558,564843772,
565226245,565608977,565991968,566375219,566758729,567142499,567526528,567910818,568295368,568680178,
569065249,569450580,569836173,570222026,570608141,570994517,571381155,571768055,572155217,572542641,
572930327,573318275,573706487,574094961,574483698,574872699,575261963,575651490,576041282,576431337,
576821656,577212240,577603088,577994201,578385579,578777221,579169129,579561302,579953741,580346445,
580739416,581132652,581526155,581919924,582313960,582708263,583102832,583497669,583892773,584288145,
584683785,585079692,585475867,585872311,586269023,586666004,587063253,587460772,587858560,588256617,
588654943,589053540,589452406,589851542,590250949,590650626,591050574,591450792,591851281,592252042,
592653074,593054378,593455953,593857800,594259920,594662311,595064975,595467912,595871122,596274604,
596678360,597082389,597486692,597891269,598296119,598701244,599106643,599512317,599918265,600324488,
600730986,601137759,601544808,601952133,602359733,602767609,603175762,603584190,603992896,604401878,
604811137,605220673,605630487,606040578,606450946,606861593,607272517,607683720,608095202,608506962,
608919000,609331318,609743915,610156791,610569947,610983383,611397098,611811094,612225370,612639927,
613054764,613469882,613885282,614300962,614716924,615133168,615549693,615966501,616383591,616800963,
617218618,617636556,618054776,618473280,618892067,619311138,619730493,620150131,620570054,620990261,
621410753,621831529,622252590,622673936,623095568,623517485,623939688,624362177,624784952,625208013,
625631360,626054994,626478915,626903124,627327619,627752402,628177472,628602830,629028477,629454411,
629880634,630307146,630733946,631161035,631588414,632016082,632444039,632872286,633300824,633729651,
634158769,634588177,635017876,635447866,635878148,636308720,636739584,637170740,637602188,638033928,
638465961,638898285,639330903,639763814,640197017,640630514,641064305,641498389,641932768,642367440,
642802407,643237668,643673224,644109075,644545221,644981662,645418399,645855432,646292760,646730385,
647168306,647606523,648045038,648483849,648922957,649362363,649802066,650242067,650682366,651122963,
651563858,652005052,652446545,652888336,653330427,653772817,654215507,654658496,655101785,655545375,
655989265,656433455,656877947,657322739,657767832,658213227,658658923,659104921,659551222,659997824,
660444729,660891936,661339446,661787260,662235376,662683796,663132520,663581547,664030878,664480514,
664930454,665380699,665831249,666282104,666733264,667184729,667636500,668088578,668540961,668993650,
669446647,669899949,670353559,670807476,671261701,671716232,672171072,672626220,673081676,673537440,
673993513,674449894,674906585,675363585,675820895,676278514,676736443,677194682,677653231,678112091,
678571261,679030743,679490535,679950639,680411055,680871782,681332821,681794172,682255836,682717812,
683180102,683642704,684105619,684568848,685032391,685496247,685960418,686424903,686889702,687354816,
687820245,688285989,688752049,689218424,689685115,690152122,690619445,691087085,691555041,692023314,
692491904,692960812,693430037,693899580,694369440,694839619,695310117,695780932,696252067,696723521,
697195294,697667386,698139798,698612530,699085582,699558954,700032647,700506660,700980995,701455651,
701930628,702405927,702881547,703357490,703833755,704310342,704787253,705264486,705742042,706219921,
706698125,707176652,707655503,708134678,708614178,709094002,709574151,710054626,710535426,711016551,
711498002,711979779,712461883,712944312,713427069,713910152,714393563,714877300,715361366,715845759,
716330480,716815529,717300907,717786614,718272649,718759014,719245707,719732731,720220084,720707767,
721195780,721684124,722172799,722661804,723151140,723640808,724130808,724621139,725111802,725602797,
726094125,726585786,727077780,727570106,728062766,728555760,729049087,729542749,730036745,730531075,
731025740,731520740,732016075,732511746,733007752};
void Freqlut::init(double sample_rate) {
}

// Note: if logfreq is more than 20.0, the results will be inaccurate. However,
// that will be many times the Nyquist rate.
int32_t Freqlut::lookup(int32_t logfreq) {
  int ix = (logfreq & 0xffffff) >> SAMPLE_SHIFT;

  int32_t y0 = lut[ix];
  int32_t y1 = lut[ix + 1];
  int lowbits = logfreq & ((1 << SAMPLE_SHIFT) - 1);
  int32_t y = y0 + ((((int64_t)(y1 - y0) * (int64_t)lowbits)) >> SAMPLE_SHIFT);
  int hibits = logfreq >> 24;
  return y >> (MAX_LOGFREQ_INT - hibits);
}
