/*
 * Copyright 2012 Google Inc.
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

class Sin {
 public:
  Sin();

  static void init();
  static int32_t lookup(int32_t phase);
  static int32_t compute(int32_t phase);

  // A more accurate sine, both input and output Q30
  static int32_t compute10(int32_t phase);
};

#define SIN_LG_N_SAMPLES 10
#define SIN_N_SAMPLES (1 << SIN_LG_N_SAMPLES)

#define SIN_INLINE

// Use twice as much RAM for the LUT but avoid a little computation
#define SIN_DELTA

#ifdef SIN_DELTA
const int32_t sintab[] = {
102943,0,102939,102943,102932,205882,102920,308814,102904,411734,
102885,514638,102861,617523,102835,720384,102804,823219,102768,926023,
102730,1028791,102688,1131521,102641,1234209,102590,1336850,102536,1439440,
102479,1541976,102416,1644455,102351,1746871,102281,1849222,102207,1951503,
102131,2053710,102049,2155841,101964,2257890,101875,2359854,101782,2461729,
101686,2563511,101586,2665197,101482,2766783,101373,2868265,101262,2969638,
101146,3070900,101026,3172046,100904,3273072,100776,3373976,100646,3474752,
100511,3575398,100372,3675909,100231,3776281,100084,3876512,99935,3976596,
99781,4076531,99624,4176312,99463,4275936,99299,4375399,99129,4474698,
98958,4573827,98782,4672785,98602,4771567,98418,4870169,98232,4968587,
98041,5066819,97846,5164860,97649,5262706,97446,5360355,97241,5457801,
97032,5555042,96819,5652074,96602,5748893,96383,5845495,96159,5941878,
95931,6038037,95701,6133968,95466,6229669,95228,6325135,94986,6420363,
94741,6515349,94492,6610090,94239,6704582,93984,6798821,93724,6892805,
93461,6986529,93194,7079990,92925,7173184,92650,7266109,92374,7358759,
92093,7451133,91810,7543226,91521,7635036,91231,7726557,90937,7817788,
90639,7908725,90337,7999364,90033,8089701,89725,8179734,89414,8269459,
89099,8358873,88781,8447972,88460,8536753,88135,8625213,87806,8713348,
87476,8801154,87141,8888630,86802,8975771,86462,9062573,86117,9149035,
85770,9235152,85418,9320922,85065,9406340,84707,9491405,84346,9576112,
83983,9660458,83616,9744441,83246,9828057,82873,9911303,82496,9994176,
82117,10076672,81735,10158789,81349,10240524,80961,10321873,80569,10402834,
80174,10483403,79776,10563577,79376,10643353,78972,10722729,78565,10801701,
78156,10880266,77743,10958422,77328,11036165,76909,11113493,76488,11190402,
76063,11266890,75637,11342953,75207,11418590,74774,11493797,74338,11568571,
73900,11642909,73459,11716809,73015,11790268,72569,11863283,72119,11935852,
71667,12007971,71212,12079638,70754,12150850,70295,12221604,69832,12291899,
69366,12361731,68898,12431097,68428,12499995,67955,12568423,67478,12636378,
67001,12703856,66519,12770857,66037,12837376,65550,12903413,65062,12968963,
64572,13034025,64078,13098597,63583,13162675,63085,13226258,62585,13289343,
62081,13351928,61577,13414009,61070,13475586,60559,13536656,60048,13597215,
59534,13657263,59017,13716797,58499,13775814,57977,13834313,57455,13892290,
56930,13949745,56402,14006675,55872,14063077,55342,14118949,54807,14174291,
54272,14229098,53734,14283370,53194,14337104,52652,14390298,52109,14442950,
51563,14495059,51015,14546622,50466,14597637,49914,14648103,49361,14698017,
48805,14747378,48249,14796183,47689,14844432,47129,14892121,46567,14939250,
46002,14985817,45436,15031819,44869,15077255,44299,15122124,43729,15166423,
43155,15210152,42582,15253307,42005,15295889,41428,15337894,40849,15379322,
40269,15420171,39686,15460440,39103,15500126,38518,15539229,37931,15577747,
37344,15615678,36754,15653022,36163,15689776,35571,15725939,34978,15761510,
34383,15796488,33787,15830871,33190,15864658,32591,15897848,31992,15930439,
31390,15962431,30788,15993821,30185,16024609,29581,16054794,28975,16084375,
28368,16113350,27761,16141718,27152,16169479,26542,16196631,25931,16223173,
25320,16249104,24706,16274424,24093,16299130,23479,16323223,22863,16346702,
22247,16369565,21630,16391812,21011,16413442,20393,16434453,19774,16454846,
19153,16474620,18532,16493773,17911,16512305,17288,16530216,16665,16547504,
16041,16564169,15418,16580210,14792,16595628,14167,16610420,13541,16624587,
12915,16638128,12288,16651043,11661,16663331,11032,16674992,10405,16686024,
9776,16696429,9147,16706205,8517,16715352,7888,16723869,7258,16731757,
6628,16739015,5997,16745643,5367,16751640,4735,16757007,4105,16761742,
3474,16765847,2842,16769321,2210,16772163,1579,16774373,948,16775952,
316,16776900,-316,16777216,-948,16776900,-1579,16775952,-2210,16774373,
-2842,16772163,-3474,16769321,-4105,16765847,-4735,16761742,-5367,16757007,
-5997,16751640,-6628,16745643,-7258,16739015,-7888,16731757,-8518,16723869,
-9146,16715351,-9776,16706205,-10405,16696429,-11033,16686024,-11660,16674991,
-12288,16663331,-12915,16651043,-13541,16638128,-14167,16624587,-14792,16610420,
-15418,16595628,-16041,16580210,-16665,16564169,-17289,16547504,-17910,16530215,
-18532,16512305,-19154,16493773,-19773,16474619,-20393,16454846,-21012,16434453,
-21629,16413441,-22247,16391812,-22863,16369565,-23479,16346702,-24093,16323223,
-24707,16299130,-25319,16274423,-25931,16249104,-26542,16223173,-27152,16196631,
-27761,16169479,-28368,16141718,-28975,16113350,-29581,16084375,-30185,16054794,
-30788,16024609,-31391,15993821,-31991,15962430,-32591,15930439,-33190,15897848,
-33787,15864658,-34383,15830871,-34978,15796488,-35571,15761510,-36164,15725939,
-36754,15689775,-37343,15653021,-37931,15615678,-38518,15577747,-39103,15539229,
-39686,15500126,-40269,15460440,-40849,15420171,-41428,15379322,-42005,15337894,
-42582,15295889,-43156,15253307,-43728,15210151,-44299,15166423,-44869,15122124,
-45436,15077255,-46002,15031819,-46567,14985817,-47129,14939250,-47689,14892121,
-48249,14844432,-48806,14796183,-49360,14747377,-49914,14698017,-50466,14648103,
-51015,14597637,-51563,14546622,-52109,14495059,-52652,14442950,-53195,14390298,
-53734,14337103,-54271,14283369,-54808,14229098,-55341,14174290,-55873,14118949,
-56402,14063076,-56929,14006674,-57455,13949745,-57978,13892290,-58498,13834312,
-59018,13775814,-59533,13716796,-60048,13657263,-60560,13597215,-61069,13536655,
-61577,13475586,-62082,13414009,-62584,13351927,-63085,13289343,-63583,13226258,
-64078,13162675,-64572,13098597,-65062,13034025,-65551,12968963,-66036,12903412,
-66520,12837376,-67000,12770856,-67479,12703856,-67955,12636377,-68427,12568422,
-68899,12499995,-69366,12431096,-69832,12361730,-70294,12291898,-70755,12221604,
-71212,12150849,-71667,12079637,-72119,12007970,-72568,11935851,-73015,11863283,
-73459,11790268,-73901,11716809,-74338,11642908,-74774,11568570,-75207,11493796,
-75636,11418589,-76064,11342953,-76488,11266889,-76909,11190401,-77328,11113492,
-77743,11036164,-78155,10958421,-78566,10880266,-78972,10801700,-79375,10722728,
-79777,10643353,-80174,10563576,-80569,10483402,-80960,10402833,-81349,10321873,
-81735,10240524,-82117,10158789,-82497,10076672,-82873,9994175,-83245,9911302,
-83616,9828057,-83983,9744441,-84347,9660458,-84707,9576111,-85064,9491404,
-85419,9406340,-85769,9320921,-86117,9235152,-86462,9149035,-86803,9062573,
-87141,8975770,-87475,8888629,-87807,8801154,-88135,8713347,-88459,8625212,
-88781,8536753,-89099,8447972,-89414,8358873,-89725,8269459,-90033,8179734,
-90338,8089701,-90639,7999363,-90936,7908724,-91231,7817788,-91522,7726557,
-91809,7635035,-92093,7543226,-92374,7451133,-92651,7358759,-92924,7266108,
-93195,7173184,-93461,7079989,-93724,6986528,-93984,6892804,-94239,6798820,
-94492,6704581,-94741,6610089,-94986,6515348,-95228,6420362,-95466,6325134,
-95700,6229668,-95932,6133968,-96159,6038036,-96382,5941877,-96603,5845495,
-96819,5748892,-97032,5652073,-97241,5555041,-97446,5457800,-97648,5360354,
-97847,5262706,-98040,5164859,-98232,5066819,-98419,4968587,-98602,4870168,
-98782,4771566,-98957,4672784,-99130,4573827,-99298,4474697,-99463,4375399,
-99624,4275936,-99782,4176312,-99934,4076530,-100085,3976596,-100230,3876511,
-100373,3776281,-100511,3675908,-100645,3575397,-100777,3474752,-100903,3373975,
-101027,3273072,-101146,3172045,-101261,3070899,-101374,2969638,-101481,2868264,
-101586,2766783,-101686,2665197,-101783,2563511,-101875,2461728,-101964,2359853,
-102049,2257889,-102130,2155840,-102208,2053710,-102281,1951502,-102350,1849221,
-102417,1746871,-102478,1644454,-102536,1541976,-102591,1439440,-102641,1336849,
-102687,1234208,-102730,1131521,-102769,1028791,-102803,926022,-102835,823219,
-102862,720384,-102885,617522,-102904,514637,-102920,411733,-102931,308813,
-102939,205882,-102943,102943,-102943,0,-102939,-102943,-102932,-205882,
-102920,-308814,-102904,-411734,-102885,-514638,-102861,-617523,-102835,-720384,
-102804,-823219,-102768,-926023,-102730,-1028791,-102688,-1131521,-102641,-1234209,
-102590,-1336850,-102536,-1439440,-102479,-1541976,-102416,-1644455,-102351,-1746871,
-102281,-1849222,-102207,-1951503,-102131,-2053710,-102049,-2155841,-101964,-2257890,
-101875,-2359854,-101782,-2461729,-101686,-2563511,-101586,-2665197,-101482,-2766783,
-101373,-2868265,-101262,-2969638,-101146,-3070900,-101026,-3172046,-100904,-3273072,
-100776,-3373976,-100646,-3474752,-100511,-3575398,-100372,-3675909,-100231,-3776281,
-100084,-3876512,-99935,-3976596,-99781,-4076531,-99624,-4176312,-99463,-4275936,
-99299,-4375399,-99129,-4474698,-98958,-4573827,-98782,-4672785,-98602,-4771567,
-98418,-4870169,-98232,-4968587,-98041,-5066819,-97846,-5164860,-97649,-5262706,
-97446,-5360355,-97241,-5457801,-97032,-5555042,-96819,-5652074,-96602,-5748893,
-96383,-5845495,-96159,-5941878,-95931,-6038037,-95701,-6133968,-95466,-6229669,
-95228,-6325135,-94986,-6420363,-94741,-6515349,-94492,-6610090,-94239,-6704582,
-93984,-6798821,-93724,-6892805,-93461,-6986529,-93194,-7079990,-92925,-7173184,
-92650,-7266109,-92374,-7358759,-92093,-7451133,-91810,-7543226,-91521,-7635036,
-91231,-7726557,-90937,-7817788,-90639,-7908725,-90337,-7999364,-90033,-8089701,
-89725,-8179734,-89414,-8269459,-89099,-8358873,-88781,-8447972,-88460,-8536753,
-88135,-8625213,-87806,-8713348,-87476,-8801154,-87141,-8888630,-86802,-8975771,
-86462,-9062573,-86117,-9149035,-85770,-9235152,-85418,-9320922,-85065,-9406340,
-84707,-9491405,-84346,-9576112,-83983,-9660458,-83616,-9744441,-83246,-9828057,
-82873,-9911303,-82496,-9994176,-82117,-10076672,-81735,-10158789,-81349,-10240524,
-80961,-10321873,-80569,-10402834,-80174,-10483403,-79776,-10563577,-79376,-10643353,
-78972,-10722729,-78565,-10801701,-78156,-10880266,-77743,-10958422,-77328,-11036165,
-76909,-11113493,-76488,-11190402,-76063,-11266890,-75637,-11342953,-75207,-11418590,
-74774,-11493797,-74338,-11568571,-73900,-11642909,-73459,-11716809,-73015,-11790268,
-72569,-11863283,-72119,-11935852,-71667,-12007971,-71212,-12079638,-70754,-12150850,
-70295,-12221604,-69832,-12291899,-69366,-12361731,-68898,-12431097,-68428,-12499995,
-67955,-12568423,-67478,-12636378,-67001,-12703856,-66519,-12770857,-66037,-12837376,
-65550,-12903413,-65062,-12968963,-64572,-13034025,-64078,-13098597,-63583,-13162675,
-63085,-13226258,-62585,-13289343,-62081,-13351928,-61577,-13414009,-61070,-13475586,
-60559,-13536656,-60048,-13597215,-59534,-13657263,-59017,-13716797,-58499,-13775814,
-57977,-13834313,-57455,-13892290,-56930,-13949745,-56402,-14006675,-55872,-14063077,
-55342,-14118949,-54807,-14174291,-54272,-14229098,-53734,-14283370,-53194,-14337104,
-52652,-14390298,-52109,-14442950,-51563,-14495059,-51015,-14546622,-50466,-14597637,
-49914,-14648103,-49361,-14698017,-48805,-14747378,-48249,-14796183,-47689,-14844432,
-47129,-14892121,-46567,-14939250,-46002,-14985817,-45436,-15031819,-44869,-15077255,
-44299,-15122124,-43729,-15166423,-43155,-15210152,-42582,-15253307,-42005,-15295889,
-41428,-15337894,-40849,-15379322,-40269,-15420171,-39686,-15460440,-39103,-15500126,
-38518,-15539229,-37931,-15577747,-37344,-15615678,-36754,-15653022,-36163,-15689776,
-35571,-15725939,-34978,-15761510,-34383,-15796488,-33787,-15830871,-33190,-15864658,
-32591,-15897848,-31992,-15930439,-31390,-15962431,-30788,-15993821,-30185,-16024609,
-29581,-16054794,-28975,-16084375,-28368,-16113350,-27761,-16141718,-27152,-16169479,
-26542,-16196631,-25931,-16223173,-25320,-16249104,-24706,-16274424,-24093,-16299130,
-23479,-16323223,-22863,-16346702,-22247,-16369565,-21630,-16391812,-21011,-16413442,
-20393,-16434453,-19774,-16454846,-19153,-16474620,-18532,-16493773,-17911,-16512305,
-17288,-16530216,-16665,-16547504,-16041,-16564169,-15418,-16580210,-14792,-16595628,
-14167,-16610420,-13541,-16624587,-12915,-16638128,-12288,-16651043,-11661,-16663331,
-11032,-16674992,-10405,-16686024,-9776,-16696429,-9147,-16706205,-8517,-16715352,
-7888,-16723869,-7258,-16731757,-6628,-16739015,-5997,-16745643,-5367,-16751640,
-4735,-16757007,-4105,-16761742,-3474,-16765847,-2842,-16769321,-2210,-16772163,
-1579,-16774373,-948,-16775952,-316,-16776900,316,-16777216,948,-16776900,
1579,-16775952,2210,-16774373,2842,-16772163,3474,-16769321,4105,-16765847,
4735,-16761742,5367,-16757007,5997,-16751640,6628,-16745643,7258,-16739015,
7888,-16731757,8518,-16723869,9146,-16715351,9776,-16706205,10405,-16696429,
11033,-16686024,11660,-16674991,12288,-16663331,12915,-16651043,13541,-16638128,
14167,-16624587,14792,-16610420,15418,-16595628,16041,-16580210,16665,-16564169,
17289,-16547504,17910,-16530215,18532,-16512305,19154,-16493773,19773,-16474619,
20393,-16454846,21012,-16434453,21629,-16413441,22247,-16391812,22863,-16369565,
23479,-16346702,24093,-16323223,24707,-16299130,25319,-16274423,25931,-16249104,
26542,-16223173,27152,-16196631,27761,-16169479,28368,-16141718,28975,-16113350,
29581,-16084375,30185,-16054794,30788,-16024609,31391,-15993821,31991,-15962430,
32591,-15930439,33190,-15897848,33787,-15864658,34383,-15830871,34978,-15796488,
35571,-15761510,36164,-15725939,36754,-15689775,37343,-15653021,37931,-15615678,
38518,-15577747,39103,-15539229,39686,-15500126,40269,-15460440,40849,-15420171,
41428,-15379322,42005,-15337894,42582,-15295889,43156,-15253307,43728,-15210151,
44299,-15166423,44869,-15122124,45436,-15077255,46002,-15031819,46567,-14985817,
47129,-14939250,47689,-14892121,48249,-14844432,48806,-14796183,49360,-14747377,
49914,-14698017,50466,-14648103,51015,-14597637,51563,-14546622,52109,-14495059,
52652,-14442950,53195,-14390298,53734,-14337103,54271,-14283369,54808,-14229098,
55341,-14174290,55873,-14118949,56402,-14063076,56929,-14006674,57455,-13949745,
57978,-13892290,58498,-13834312,59018,-13775814,59533,-13716796,60048,-13657263,
60560,-13597215,61069,-13536655,61577,-13475586,62082,-13414009,62584,-13351927,
63085,-13289343,63583,-13226258,64078,-13162675,64572,-13098597,65062,-13034025,
65551,-12968963,66036,-12903412,66520,-12837376,67000,-12770856,67479,-12703856,
67955,-12636377,68427,-12568422,68899,-12499995,69366,-12431096,69832,-12361730,
70294,-12291898,70755,-12221604,71212,-12150849,71667,-12079637,72119,-12007970,
72568,-11935851,73015,-11863283,73459,-11790268,73901,-11716809,74338,-11642908,
74774,-11568570,75207,-11493796,75636,-11418589,76064,-11342953,76488,-11266889,
76909,-11190401,77328,-11113492,77743,-11036164,78155,-10958421,78566,-10880266,
78972,-10801700,79375,-10722728,79777,-10643353,80174,-10563576,80569,-10483402,
80960,-10402833,81349,-10321873,81735,-10240524,82117,-10158789,82497,-10076672,
82873,-9994175,83245,-9911302,83616,-9828057,83983,-9744441,84347,-9660458,
84707,-9576111,85064,-9491404,85419,-9406340,85769,-9320921,86117,-9235152,
86462,-9149035,86803,-9062573,87141,-8975770,87475,-8888629,87807,-8801154,
88135,-8713347,88459,-8625212,88781,-8536753,89099,-8447972,89414,-8358873,
89725,-8269459,90033,-8179734,90338,-8089701,90639,-7999363,90936,-7908724,
91231,-7817788,91522,-7726557,91809,-7635035,92093,-7543226,92374,-7451133,
92651,-7358759,92924,-7266108,93195,-7173184,93461,-7079989,93724,-6986528,
93984,-6892804,94239,-6798820,94492,-6704581,94741,-6610089,94986,-6515348,
95228,-6420362,95466,-6325134,95700,-6229668,95932,-6133968,96159,-6038036,
96382,-5941877,96603,-5845495,96819,-5748892,97032,-5652073,97241,-5555041,
97446,-5457800,97648,-5360354,97847,-5262706,98040,-5164859,98232,-5066819,
98419,-4968587,98602,-4870168,98782,-4771566,98957,-4672784,99130,-4573827,
99298,-4474697,99463,-4375399,99624,-4275936,99782,-4176312,99934,-4076530,
100085,-3976596,100230,-3876511,100373,-3776281,100511,-3675908,100645,-3575397,
100777,-3474752,100903,-3373975,101027,-3273072,101146,-3172045,101261,-3070899,
101374,-2969638,101481,-2868264,101586,-2766783,101686,-2665197,101783,-2563511,
101875,-2461728,101964,-2359853,102049,-2257889,102130,-2155840,102208,-2053710,
102281,-1951502,102350,-1849221,102417,-1746871,102478,-1644454,102536,-1541976,
102591,-1439440,102641,-1336849,102687,-1234208,102730,-1131521,102769,-1028791,
102803,-926022,102835,-823219,102862,-720384,102885,-617522,102904,-514637,
102920,-411733,102931,-308813,102939,-205882,102943,-102943};
#else
extern int32_t sintab[SIN_N_SAMPLES + 1];
#endif

#ifdef SIN_INLINE
inline
int32_t Sin::lookup(int32_t phase) {
  const int SHIFT = 24 - SIN_LG_N_SAMPLES;
  int lowbits = phase & ((1 << SHIFT) - 1);
#ifdef SIN_DELTA
  int phase_int = (phase >> (SHIFT - 1)) & ((SIN_N_SAMPLES - 1) << 1);
  int dy = sintab[phase_int];
  int y0 = sintab[phase_int + 1];

  return y0 + (((int64_t)dy * (int64_t)lowbits) >> SHIFT);
#else
  int phase_int = (phase >> SHIFT) & (SIN_N_SAMPLES - 1);
  int y0 = sintab[phase_int];
  int y1 = sintab[phase_int + 1];

  return y0 + (((int64_t)(y1 - y0) * (int64_t)lowbits) >> SHIFT);
#endif
}
#endif
